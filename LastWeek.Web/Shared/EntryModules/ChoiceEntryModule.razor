@namespace LastWeek.Shared.EntryModules

<div>
    @if (!edit)
    {
        <InputSelect @bind-Value="Entry.Selected">
            @if (Entry?.Choices != null)
            {
            @foreach (var choice in Entry.Choices)
                {
                <option value="@choice">@choice</option>
                }
            }
        </InputSelect>
    }
    else
    {
        if (Entry?.Choices != null)
        {
            @foreach (var choice in Entry.Choices.Select((a, i) => new { Choice = a, Index = i }))
            {
                <InputText placeholder="@Entry.Question" Value="@choices[choice.Index].Value"
               ValueExpression="@(() => choices[choice.Index].Value)"
               @onkeyup="@(() => OnValueChanged(choice.Index))"
               ValueChanged="@((string value) => OnValueChanged(choice.Index))" />
                <input type="button" @onclick="@(() => RemoveOption(choice.Index))" value="X"></input>
            }
        }
    }
    <input type="button" @onclick="ToggleEdit" value="Edit" />
    <div>
        <InputText @bind-Value="newChoice" />
        <input type="button" @onclick="AddChoice" value="+" />
    </div>
</div>

@code {
    [Parameter]
    public ChoiceEntry Entry { get; set; } = new();
    private bool edit = false;
    private string newChoice = string.Empty;
    private List<FormResponse> choices = new();

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (Entry.Choices == null) Entry.Choices = new();
        choices = Entry.Choices.Select(s => new FormResponse { Value = s }).ToList();
    }

    protected void ToggleEdit()
    {
        edit = !edit;
    }

    protected void AddChoice()
    {
        if (Entry.Choices == null) Entry.Choices = new();
        Entry.Choices.Add(newChoice);
        choices.Add(new FormResponse { Value = newChoice });
        Entry.Selected = newChoice;
        newChoice = string.Empty;
    }

    private void OnValueChanged(int index)
    {
        Entry.Choices[index] = choices[index].Value;
    }

    private void RemoveOption(int index)
    {
        Entry.Choices.RemoveAt(index);
        choices.RemoveAt(index);
    }
}