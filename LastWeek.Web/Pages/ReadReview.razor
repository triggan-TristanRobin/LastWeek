@page "/Review/{ReviewId}"
@using System.Text.Json
@using DataManager.Helpers
@inject IAuthService AuthService
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject HttpClient apiClient

<section>
    @if (Review == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <h1>@Review.Status</h1>
        <EditForm Model="@Review">
        <label>@($"Review from {Review.StartDate.ToShortDateString()} to  {Review.EndDate.ToShortDateString()}")</label>
        @if (Review.Entries != null)
        {
            @foreach (var entry in Review.Entries)
            {
                <EntryTemplate Entry="@entry" />
            }
        }
        </EditForm>
        <a href="/">Back</a>
    }
</section>

@code {
    [Parameter]
    public string? ReviewId { get; set; }
    [Parameter]
    public Review? Review { get; set; }
    private User signedUser = new User();

    protected override async Task OnInitializedAsync()
    {
        var hasKey = await localStorage.ContainKeyAsync("user");
        var saved = await localStorage.GetItemAsync<User>("user");

        Console.WriteLine($"Tried to retrieve key: {hasKey} - {saved?.Guid}");

        if (hasKey)
        {
            this.signedUser = saved!;
            await GetUserReview();
        }
        else
        {
            Review = new()
                {
                    StartDate = DateTime.Today.AddDays(-19),
                    EndDate = DateTime.Today.AddDays(-12),
                };
        }
    }

    protected async Task GetUserReview()
    {
        var serializeOptions = new JsonSerializerOptions();
        serializeOptions.Converters.Add(new EntryConverter());
        Review = await apiClient.GetFromJsonAsync<Review>($"Review?guid={ReviewId}", serializeOptions) ?? new();
    }
}
